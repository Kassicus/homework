{% extends "base/layout.html" %}

{% block title %}Dashboard - Contract Management{% endblock %}

{% block content %}
<!-- Dashboard Header -->
<header class="dashboard-header">
    <h1>Dashboard</h1>
    <div class="user-info">
        <span>Welcome back, <strong>{{ current_user.username }}</strong></span>
        <div class="user-avatar">{{ current_user.username[:2].upper() }}</div>
    </div>
</header>

<!-- Universal Search Component -->
{% set search_action = url_for('contracts.search') %}
{% set search_placeholder = 'Quick search across contracts, clients, and content...' %}
{% set search_types = [
    ('contracts', 'Contracts'),
    ('clients', 'Clients'),
    ('all', 'All')
] %}
{% set status_options = [
    ('draft', 'Draft'),
    ('under_review', 'Under Review'),
    ('active', 'Active'),
    ('expired', 'Expired'),
    ('terminated', 'Terminated'),
    ('renewed', 'Renewed')
] %}
{% set show_client_filter = true %}
{% set show_contract_type_filter = true %}

{% include 'components/universal_search.html' %}

<!-- Statistics Grid -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-title">Total Contracts</div>
            <div class="stat-icon" style="background: var(--gradient-blue);">📄</div>
        </div>
        <div class="stat-number">{{ dashboard_data.stats.total_contracts if dashboard_data and dashboard_data.stats else 0 }}</div>
        <div class="stat-change positive">📈 +{{ dashboard_data.stats.contracts_this_month if dashboard_data and dashboard_data.stats else 0 }} this month</div>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-title">Active Contracts</div>
            <div class="stat-icon" style="background: var(--gradient-green);">✅</div>
        </div>
        <div class="stat-number">{{ dashboard_data.stats.active_contracts if dashboard_data and dashboard_data.stats else 0 }}</div>
        <div class="stat-change positive">✅ Currently active</div>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-title">Expiring Soon</div>
            <div class="stat-icon" style="background: var(--gradient-orange);">⚠️</div>
        </div>
        <div class="stat-number">{{ dashboard_data.stats.expiring_contracts if dashboard_data and dashboard_data.stats else 0 }}</div>
        <div class="stat-change negative">⏰ Next 30 days</div>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-title">Total Clients</div>
            <div class="stat-icon" style="background: var(--gradient-red);">👥</div>
        </div>
        <div class="stat-number">{{ dashboard_data.client_count if dashboard_data else 0 }}</div>
        <div class="stat-change positive">📈 +{{ dashboard_data.stats.clients_this_month if dashboard_data and dashboard_data.stats else 0 }} this month</div>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-title">Total Value</div>
            <div class="stat-icon" style="background: var(--gradient-purple);">💰</div>
        </div>
        <div class="stat-number">${{ "{:,.0f}".format(dashboard_data.stats.total_value) if dashboard_data and dashboard_data.stats and dashboard_data.stats.total_value else "0" }}</div>
        <div class="stat-change positive">💼 Portfolio value</div>
    </div>
</div>

<!-- Content Grid -->
<div class="content-grid">
    <!-- Main Panel -->
    <div class="main-panel">
        <!-- Quick Actions & Contract Status Distribution -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">⚡ Quick Actions & Status Overview</h2>
            </div>
            <div class="card-content">
                <div class="quick-actions-status-grid">
                    <!-- Quick Actions Section -->
                    <div class="quick-actions-section">
                        <h3 class="section-subtitle">Quick Actions</h3>
                        <div class="quick-actions-horizontal">
                            <a href="{{ url_for('contracts.new') }}" class="action-btn-compact">
                                <span class="action-icon-compact">📁</span>
                                <span class="action-text">Upload Contract</span>
                            </a>
                            <a href="{{ url_for('clients.new') }}" class="action-btn-compact">
                                <span class="action-icon-compact">👤</span>
                                <span class="action-text">Add Client</span>
                            </a>
                            <a href="{{ url_for('contracts.search') }}" class="action-btn-compact">
                                <span class="action-icon-compact">📊</span>
                                <span class="action-text">Generate Report</span>
                            </a>
                            <a href="{{ url_for('contracts.search') }}" class="action-btn-compact">
                                <span class="action-icon-compact">🔍</span>
                                <span class="action-text">Advanced Search</span>
                            </a>
                        </div>
                    </div>
                    
                    <!-- Contract Status Distribution Section -->
                    <div class="status-distribution-section">
                        <h3 class="section-subtitle">Contract Status Distribution</h3>
                        <div class="status-chart-compact">
                            {% if dashboard_data and dashboard_data.stats %}
                                {% set max_value = [dashboard_data.stats.active_contracts, dashboard_data.stats.draft_contracts, dashboard_data.stats.review_contracts, dashboard_data.stats.expired_contracts]|max %}
                                {% set max_value = max_value if max_value > 0 else 1 %}
                                <div class="chart-container-compact">
                                    <div class="chart-bar-compact" style="--bar-height: {{ (dashboard_data.stats.active_contracts / max_value * 100)|round }}%;" data-value="{{ dashboard_data.stats.active_contracts }}"></div>
                                    <div class="chart-bar-compact" style="--bar-height: {{ (dashboard_data.stats.draft_contracts / max_value * 100)|round }}%;" data-value="{{ dashboard_data.stats.draft_contracts }}"></div>
                                    <div class="chart-bar-compact" style="--bar-height: {{ (dashboard_data.stats.review_contracts / max_value * 100)|round }}%;" data-value="{{ dashboard_data.stats.review_contracts }}"></div>
                                    <div class="chart-bar-compact" style="--bar-height: {{ (dashboard_data.stats.expired_contracts / max_value * 100)|round }}%;" data-value="{{ dashboard_data.stats.expired_contracts }}"></div>
                                </div>
                                <div class="chart-labels-compact">
                                    <div class="chart-label-compact">Active<br><small>{{ dashboard_data.stats.active_contracts }}</small></div>
                                    <div class="chart-label-compact">Draft<br><small>{{ dashboard_data.stats.draft_contracts }}</small></div>
                                    <div class="chart-label-compact">Review<br><small>{{ dashboard_data.stats.review_contracts }}</small></div>
                                    <div class="chart-label-compact">Expired<br><small>{{ dashboard_data.stats.expired_contracts }}</small></div>
                                </div>
                            {% else %}
                                <div class="chart-container-compact">
                                    <div class="chart-bar-compact" style="--bar-height: 0%;" data-value="0"></div>
                                    <div class="chart-bar-compact" style="--bar-height: 0%;" data-value="0"></div>
                                    <div class="chart-bar-compact" style="--bar-height: 0%;" data-value="0"></div>
                                    <div class="chart-bar-compact" style="--bar-height: 0%;" data-value="0"></div>
                                </div>
                                <div class="chart-labels-compact">
                                    <div class="chart-label-compact">Active<br><small>0</small></div>
                                    <div class="chart-label-compact">Draft<br><small>0</small></div>
                                    <div class="chart-label-compact">Review<br><small>0</small></div>
                                    <div class="chart-label-compact">Expired<br><small>0</small></div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">🔄 Recent Activity</h2>
            </div>
            <div class="card-content">
                {% if dashboard_data and dashboard_data.recent_activity %}
                    {% for activity in dashboard_data.recent_activity[:4] %}
                    <div class="activity-item">
                        {% if activity.new_status == 'active' %}
                            <div class="activity-icon" style="background: var(--gradient-green);">✅</div>
                        {% elif activity.new_status == 'expired' %}
                            <div class="activity-icon" style="background: var(--gradient-red);">⚠️</div>
                        {% elif activity.new_status == 'draft' %}
                            <div class="activity-icon" style="background: var(--gradient-orange);">📝</div>
                        {% else %}
                            <div class="activity-icon" style="background: var(--gradient-blue);">📄</div>
                        {% endif %}
                        <div class="activity-content">
                            <div class="activity-description">
                                {% if activity.contract %}
                                    <strong>{{ activity.contract.title }}</strong> - 
                                {% endif %}
                                {{ activity.change_reason or 'Status updated' }} from 
                                <span class="badge bg-secondary">{{ activity.old_status|title }}</span> 
                                to 
                                <span class="badge bg-primary">{{ activity.new_status|title }}</span>
                                {% if activity.changed_by_user %}
                                    by {{ activity.changed_by_user.username }}
                                {% endif %}
                            </div>
                            <div class="activity-time">{{ activity.changed_at.strftime('%b %d, %Y at %I:%M %p') if activity.changed_at else 'N/A' }}</div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="activity-item">
                        <div class="activity-icon" style="background: var(--gradient-blue);">📁</div>
                        <div class="activity-content">
                            <div class="activity-description">
                                <strong>Welcome to Contract Manager!</strong> - Start by creating your first contract
                            </div>
                            <div class="activity-time">Just now</div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>


    </div>

    <!-- Side Panel -->
    <div class="side-panel">
        <!-- Expiring Contracts -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">⏰ Contracts Expiring Soon</h2>
            </div>
            <div class="card-content">
                {% if dashboard_data and dashboard_data.expiring_contracts %}
                    {% for contract in dashboard_data.expiring_contracts[:4] %}
                    <div class="expiring-contract">
                        <div class="contract-info">
                            <h4>{{ contract.title }}</h4>
                            <div class="contract-client">{{ contract.client.name if contract.client else 'N/A' }}</div>
                        </div>
                        {% if contract.expiration_date %}
                            {% set expiry_date = contract.expiration_date.date() if contract.expiration_date.date else contract.expiration_date %}
                            {% set days_until_expiry = (expiry_date - dashboard_data.today).days %}
                            {% if days_until_expiry <= 0 %}
                                <span class="expiration-badge expiration-critical">Expired</span>
                            {% elif days_until_expiry <= 7 %}
                                <span class="expiration-badge expiration-critical">{{ days_until_expiry }} days</span>
                            {% elif days_until_expiry <= 30 %}
                                <span class="expiration-badge expiration-warning">{{ days_until_expiry }} days</span>
                            {% else %}
                                <span class="expiration-badge">{{ days_until_expiry }} days</span>
                            {% endif %}
                        {% else %}
                            <span class="expiration-badge expiration-warning">No date</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="expiring-contract">
                        <div class="contract-info">
                            <h4>No Expiring Contracts</h4>
                            <div class="contract-client">All contracts are up to date</div>
                        </div>
                        <span class="expiration-badge expiration-warning">✓</span>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Personal Activity Summary -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">🎯 Your Activity This Week</h2>
            </div>
            <div class="card-content">
                <div class="activity-stat">
                    <span class="stat-label">Contracts Reviewed</span>
                    <span class="stat-value">{{ dashboard_data.user_stats.contracts_reviewed if dashboard_data and dashboard_data.user_stats else 0 }}</span>
                </div>
                <div class="activity-stat">
                    <span class="stat-label">Documents Uploaded</span>
                    <span class="stat-value">{{ dashboard_data.user_stats.documents_uploaded if dashboard_data and dashboard_data.user_stats else 0 }}</span>
                </div>
                <div class="activity-stat">
                    <span class="stat-label">Status Changes</span>
                    <span class="stat-value">{{ dashboard_data.user_stats.status_changes if dashboard_data and dashboard_data.user_stats else 0 }}</span>
                </div>
                <div class="activity-stat">
                    <span class="stat-label">Searches Performed</span>
                    <span class="stat-value">{{ dashboard_data.user_stats.searches_performed if dashboard_data and dashboard_data.user_stats else 0 }}</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


